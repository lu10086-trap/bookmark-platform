<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·»åŠ ä¹¦ç­¾ - ä¹¦ç­¾ç¤¾åŒº</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabaseåˆå§‹åŒ– -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ç›´æ¥åˆå§‹åŒ–Supabase
        const SUPABASE_URL = 'https://wxoqyzdfkkmodigszrcy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4b3F5emRma2ttb2RpZ3N6cmN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzMwMDksImV4cCI6MjA3ODUwOTAwOX0.9BeyxJVxKsmJ18Uc_jyKTIwelXWvqYE4j1TZOC8zyNk';
        
        // ç«‹å³åˆå§‹åŒ–
        if (typeof supabase !== 'undefined') {
            window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabaseåˆå§‹åŒ–æˆåŠŸ');
        }
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h1>ğŸ“š ä¹¦ç­¾ç¤¾åŒº</h1>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">é¦–é¡µ</a>
                <a href="add-bookmark.html" class="nav-link active">æ·»åŠ ä¹¦ç­¾</a>
                <a href="profile.html" class="nav-link">ä¸ªäººä¸­å¿ƒ</a>
                <div id="auth-section">
                    <button id="login-btn" class="btn btn-outline">ç™»å½•</button>
                    <button id="signup-btn" class="btn btn-primary">æ³¨å†Œ</button>
                    <div id="user-menu" class="user-menu hidden">
                        <span id="user-email"></span>
                        <button id="logout-btn" class="btn btn-outline">é€€å‡º</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="form-container">
            <h1>æ·»åŠ æ–°ä¹¦ç­¾</h1>
            <form id="add-bookmark-form" class="bookmark-form">
                <div class="form-group">
                    <label for="bookmark-title">æ ‡é¢˜ *</label>
                    <input type="text" id="bookmark-title" required>
                </div>
                
                <div class="form-group">
                    <label for="bookmark-url">ç½‘å€ *</label>
                    <input type="url" id="bookmark-url" required>
                </div>
                
                <div class="form-group">
                    <label for="bookmark-description">æè¿°</label>
                    <textarea id="bookmark-description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="bookmark-category">åˆ†ç±»</label>
                    <select id="bookmark-category">
                        <option value="">é€‰æ‹©åˆ†ç±»</option>
                        <option value="technology">æŠ€æœ¯</option>
                        <option value="design">è®¾è®¡</option>
                        <option value="education">æ•™è‚²</option>
                        <option value="entertainment">å¨±ä¹</option>
                        <option value="business">å•†ä¸š</option>
                        <option value="news">æ–°é—»</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bookmark-tags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="bookmark-tags" placeholder="JavaScript, æ•™ç¨‹, å‰ç«¯">
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="bookmark-public" checked>
                    <label for="bookmark-public">å…¬å¼€æ­¤ä¹¦ç­¾</label>
                </div>
                
                <button type="submit" class="btn btn-primary btn-large" id="submit-btn">æ·»åŠ ä¹¦ç­¾</button>
            </form>
        </div>
    </main>

    <!-- åªåŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/auth.js"></script>
    <script src="js/bookmarks.js"></script>

    <script>
        // ç®€åŒ–çš„è¡¨å•å¤„ç†é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('add-bookmark-form');
            const submitBtn = document.getElementById('submit-btn');
            let isSubmitting = false;

            // ç®€å•çš„æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
            function showMessage(message, type = 'info') {
                // ç§»é™¤ç°æœ‰æ¶ˆæ¯
                const existingMsg = document.querySelector('.form-message');
                if (existingMsg) existingMsg.remove();

                // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
                const msgDiv = document.createElement('div');
                msgDiv.className = `form-message ${type}`;
                msgDiv.textContent = message;
                msgDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                    color: white;
                    border-radius: 6px;
                    z-index: 10000;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;

                document.body.appendChild(msgDiv);

                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (msgDiv.parentNode) {
                        msgDiv.remove();
                    }
                }, 3000);
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (isSubmitting) {
                    showMessage('æ­£åœ¨æäº¤ä¸­ï¼Œè¯·ç¨å€™...', 'error');
                    return;
                }

                isSubmitting = true;
                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';

                try {
                    // è·å–è¡¨å•æ•°æ®
                    const formData = {
                        title: document.getElementById('bookmark-title').value.trim(),
                        url: document.getElementById('bookmark-url').value.trim(),
                        description: document.getElementById('bookmark-description').value.trim(),
                        category: document.getElementById('bookmark-category').value,
                        is_public: document.getElementById('bookmark-public').checked
                    };

                    // åŸºæœ¬éªŒè¯
                    if (!formData.title) {
                        throw new Error('è¯·è¾“å…¥ä¹¦ç­¾æ ‡é¢˜');
                    }
                    if (!formData.url) {
                        throw new Error('è¯·è¾“å…¥ä¹¦ç­¾ç½‘å€');
                    }

                    // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
                    if (!formData.url.startsWith('http')) {
                        formData.url = 'https://' + formData.url;
                    }

                    // å¤„ç†æ ‡ç­¾
                    const tagsInput = document.getElementById('bookmark-tags').value;
                    if (tagsInput) {
                        formData.tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
                    }

                    console.log('å‡†å¤‡æäº¤æ•°æ®:', formData);

                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
                    const { data: { user } } = await window.supabase.auth.getUser();
                    if (!user) {
                        throw new Error('è¯·å…ˆç™»å½•');
                    }

                    // ç›´æ¥ä½¿ç”¨Supabaseæ’å…¥æ•°æ®
                    const { data, error } = await window.supabase
                        .from('bookmarks')
                        .insert([{
                            ...formData,
                            user_id: user.id
                        }])
                        .select()
                        .single();

                    if (error) {
                        console.error('æ•°æ®åº“é”™è¯¯:', error);
                        throw new Error('ä¿å­˜å¤±è´¥: ' + error.message);
                    }

                    console.log('ä¿å­˜æˆåŠŸ:', data);

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage('ä¹¦ç­¾æ·»åŠ æˆåŠŸï¼', 'success');

                    // é‡ç½®è¡¨å•
                    setTimeout(() => {
                        form.reset();
                        document.getElementById('bookmark-public').checked = true;
                        showMessage('æ­£åœ¨è·³è½¬åˆ°é¦–é¡µ...', 'info');
                        
                        // è·³è½¬åˆ°é¦–é¡µ
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);
                    }, 1000);

                } catch (error) {
                    console.error('æäº¤é”™è¯¯:', error);
                    showMessage(error.message, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'æ·»åŠ ä¹¦ç­¾';
                }
            });

            // URLè¾“å…¥è‡ªåŠ¨å¡«å……æ ‡é¢˜ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
            const urlInput = document.getElementById('bookmark-url');
            const titleInput = document.getElementById('bookmark-title');

            urlInput.addEventListener('blur', function() {
                if (urlInput.value && !titleInput.value) {
                    try {
                        const domain = new URL(urlInput.value).hostname;
                        const siteName = domain.replace('www.', '').split('.')[0];
                        titleInput.value = siteName.charAt(0).toUpperCase() + siteName.slice(1);
                    } catch (e) {
                        // URLæ— æ•ˆï¼Œå¿½ç•¥
                    }
                }
            });
        });
    </script>
</body>
</html>